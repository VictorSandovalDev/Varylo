generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
}

// Enums
enum Role {
  SUPER_ADMIN
  COMPANY_ADMIN
  AGENT
}

enum Plan {
  STARTER
  PRO
  SCALE
}

enum CompanyStatus {
  ACTIVE
  SUSPENDED
}

enum ChannelType {
  WHATSAPP
  INSTAGRAM
  MESSENGER
  TELEGRAM
}

enum ChannelStatus {
  CONNECTED
  DISCONNECTED
  COMING_SOON
}

enum ConversationStatus {
  OPEN
  RESOLVED
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum AutomationPriority {
  CHATBOT_FIRST
  AI_FIRST
}

// Models

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  passwordHash  String?
  role          Role      @default(COMPANY_ADMIN)
  active        Boolean   @default(true)
  companyId     String?
  company       Company?  @relation(fields: [companyId], references: [id])
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  assignedConversations Conversation[] @relation("ConversationAgents")
  sentMessages          Message[]
}

model Company {
  id        String        @id @default(cuid())
  name      String
  status    CompanyStatus @default(ACTIVE)
  plan      Plan          @default(STARTER)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  openaiApiKey          String?
  openaiApiKeyUpdatedAt DateTime?

  users         User[]
  channels      Channel[]
  contacts      Contact[]
  conversations Conversation[]
  messages      Message[]
  insights      ConversationInsight[]
  tags          Tag[]
  aiAgents      AiAgent[]
  chatbots      Chatbot[]
}

model Channel {
  id          String        @id @default(cuid())
  companyId   String
  type        ChannelType
  status      ChannelStatus @default(CONNECTED)
  configJson  Json?         // WhatsApp credentials etc.
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  automationPriority AutomationPriority @default(CHATBOT_FIRST)

  company     Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  conversations Conversation[]
  aiAgents    AiAgent[]     @relation("AiAgentChannels")
  chatbots    Chatbot[]     @relation("ChatbotChannels")
}

model Contact {
  id          String   @id @default(cuid())
  companyId   String
  name        String?
  email       String?
  phone       String
  companyName String?
  city        String?
  country     String?
  countryCode String?
  bio         String?
  imageUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  conversations Conversation[]
  tags          Tag[]
}

model Conversation {
  id              String             @id @default(cuid())
  companyId       String
  channelId       String
  contactId       String

  // assignedAgentId removed
  status          ConversationStatus @default(OPEN)
  lastMessageAt   DateTime           @default(now())
  lastInboundAt   DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  company         Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  channel         Channel            @relation(fields: [channelId], references: [id])
  contact         Contact            @relation(fields: [contactId], references: [id])
  handledByAiAgentId String?
  handledByAiAgent   AiAgent?           @relation(fields: [handledByAiAgentId], references: [id])

  assignedAgents  User[]             @relation("ConversationAgents")
  priority        Priority           @default(MEDIUM)

  messages        Message[]
  insights        ConversationInsight[]
  tags            Tag[]
  chatbotSessions ChatbotSession[]
}

model Message {
  id                String           @id @default(cuid())
  companyId         String
  conversationId    String
  direction         MessageDirection
  from              String
  to                String
  content           String
  providerMessageId String?
  timestamp         DateTime         @default(now())
  createdAt         DateTime         @default(now())
  senderId          String?
  sender            User?            @relation(fields: [senderId], references: [id])

  company           Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  conversation      Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

model ContactLead {
  id        String   @id @default(cuid())
  name      String
  email     String
  message   String
  createdAt DateTime @default(now())
}

model ConversationInsight {
  id             String   @id @default(cuid())
  companyId      String
  conversationId String
  toneScore      Int?     // 1-100
  clarityScore   Int?     // 1-100
  flagsJson      Json?
  summary        String?
  createdAt      DateTime @default(now())

  company        Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

model Tag {
  id            String   @id @default(cuid())
  companyId     String
  name          String
  description   String?
  color         String   @default("#E91E63") // default pink/magenta as in mockup
  showInSidebar Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  conversations Conversation[]
  contacts      Contact[]
}

model AiAgent {
  id                 String    @id @default(cuid())
  companyId          String
  name               String
  systemPrompt       String    @db.Text
  contextInfo        String?   @db.Text
  active             Boolean   @default(true)
  model              String    @default("gpt-4o-mini")
  temperature        Float     @default(0.7)
  transferKeywords   String[]  @default(["humano", "agente", "persona"])
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  company            Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  channels           Channel[] @relation("AiAgentChannels")
  conversations      Conversation[]
}

model Chatbot {
  id        String   @id @default(cuid())
  companyId String
  name      String
  active    Boolean  @default(true)
  flowJson  Json
  priority  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  channels  Channel[] @relation("ChatbotChannels")
  sessions  ChatbotSession[]
}

model ChatbotSession {
  id             String       @id @default(cuid())
  chatbotId      String
  conversationId String
  currentNodeId  String
  completed      Boolean      @default(false)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  chatbot        Chatbot      @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}
